#!/bin/bash
# Deletes AWS resources for an application

BIN_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}")"; pwd -P )"; source "$BIN_DIR/../include/common"
set -e # Abort on error
set -u # Abort on undeclared variable

help_text() {
    echo "Usage:"
    echo "  deleteApplication"
    echo "    - deletes all configurations/resources for the given application"
    exit 0
}

if [[ $# -ge 1 && ( "$1" = "-h" || "$1" == "--help" ) ]]; then
    help_text
fi

applicationRoot="$( findApplicationRoot )"
loadApplicationProperties "$applicationRoot"

affirm "-- Are you sure you want to delete all AWS resources associated with application: $APPLICATION_NAME (at $applicationRoot)?"

echo "-- Checking if IAM role $DEPLOYER_IAM_ROLE_NAME exists"
deployerRoleExists=$( isExitSuccess aws iam get-role --role-name "$DEPLOYER_IAM_ROLE_NAME" )
if [[ "$deployerRoleExists" = "false" ]]; then
    echo "---- No IAM role $DEPLOYER_IAM_ROLE_NAME found"
else
#    echo "---- Detaching Code Deploy managed policy from role"
#    aws iam detach-role-policy --role-name "$DEPLOYER_IAM_ROLE_NAME" --policy-arn "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforAWSCodeDeploy"
    
    echo "---- Deleting IAM role $DEPLOYER_IAM_ROLE_NAME"
    aws iam delete-role --role-name "$DEPLOYER_IAM_ROLE_NAME"
fi

applicationSecurityGroupExists=$( isExitSuccess aws ec2 describe-security-groups --group-names "$APPLICATION_SECURITY_GROUP_NAME" )
if [[ "$applicationSecurityGroupExists" = "false" ]]; then
    echo "---- No security group $APPLICATION_SECURITY_GROUP_NAME found"
else
    echo "---- Deleting security group $APPLICATION_SECURITY_GROUP_NAME"
    aws ec2 delete-security-group --group-name "$APPLICATION_SECURITY_GROUP_NAME"
fi

codeDeployS3BucketExists=$( isExitSuccess aws s3api head-bucket --bucket "$CODE_DEPLOY_S3_BUCKET_NAME" )
if [[ "$codeDeployS3BucketExists" = "false" ]]; then
    echo "---- No code deploy s3 bucket $CODE_DEPLOY_S3_BUCKET_NAME found"
else
    echo "---- Deleting code deploy s3 bucket $CODE_DEPLOY_S3_BUCKET_NAME"
    aws s3api delete-bucket --bucket "$CODE_DEPLOY_S3_BUCKET_NAME"
fi

echo "-- All resources for application $APPLICATION_NAME are released (except EC2 keypair in ~/.ssh/$EC2_KEYPAIR_NAME.pem)"
